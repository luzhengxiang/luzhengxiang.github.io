---
title: 关于蚂蚁森林每天早上是如何生成能量的思考
date: 2020-08-20 09:58:42
tags: java
typora-copy-images-to: ../img/java/ant_forest
---

# 前言
我可以算是蚂蚁森林的忠实用户了，长期霸榜我支付宝好友里蚂蚁森林总排行榜和周排行榜的第一名，带来的后果就是经常被人"丢大便"。更有甚者直接拉黑警告~   可是这玩意儿和很久以前的qq农场种菜一样特别让人上瘾，特别是能量够了以后申请去种出来一颗真树，会让我有一种我在为地球做贡献的感觉，我会想以后我要来内蒙古来大西北来看看我种下的树，反正就是感觉特别好。

然后又是一个平平常常的早上，我一睁开眼就就是打开手机来支付宝"偷能量"，突然就思考到了一个问题，蚂蚁森林的玩家数量可是千万级别的，这么大的一个用户量，那么他是如何做到在固定的这么短的时间段内把所有用户前一天的步数转换成能量的。如果这个功能换我来实现我要怎么做。

# 思考

根据我的观察，并不是所有的用户生成能量的时间点都是一样的，我每天早上能量生成的时间是7:13。非常准时，这个时间点我进入到蚂蚁森林中不是所有人的能量都在这一刻好了，最晚的会到7:20多才生成，最早的可能在我之前就生成好了。我大致可以猜想，能量是从7点开始生成的，大致在7点半左右就执行结束了。

这个功能显然是定时任务去做的。定时任务这个东西在后端开发中是非常常用的一个技术，我在以前的公司也负责过一些类似场景的开发，比如每天对存续合约生成管理费收费单据。我们的定时任务是单独一台服务器部署，大约两千个合约，全部管理费收费单据生成完成需要1~2分钟。具体的执行时间根据合约数量的多少不固定。

当时的定时任务整个模块是我自己封装的，就是基于quartz去实现的，定时任务作为一个单独的工程，启动的时候去数据库定时任务表中加载定时任务，同时这个工程对外提供restful接口，支持动态的添加，启动，暂停定时任务。以及定时任务执行状态和执行时间的监控。定时任务日志是记录到数据库定时任务日志表中。在我们自己开发的后台管理系统去针对定时任务模块提供的restful接口开发维护界面，根据定时任务日志表开发日志监控界面。

这样的实现应对我之前公司的业务场景是完全可以应付的，可维护可监控并且单独部署的定任务模块。但是我沿用这个框架是否可以解决蚂蚁森林的这个问题。显然是不行的。最大的问题是数据量的不同，我之前的业务场景只是对几千条合约去产生收费单据，1~2分钟的时间是可以忍受的，哪怕是业务10倍的增长，10-20分钟的执行时间也并不是非常致命的问题，而且单单从产生收费单据这个功能来说，肯定是还有优化的空间，在不改动整体系统架构的情况下，也是有条件去优化从而减少定时任务的执行时间。那么千万级的数据如何给定时任务提高执行时间呢？

定时任务必须支持任务的分片执行，这样多台机器同时执行定时任务，比如10万的数据，每台机器只执行1万条数据。才可以真正的提高整个一个任务的执行效率。

# 开源解决方案

不重复造轮子的前提下，搜索找到了国内应用比较火的两款分布式任务调度框架。xxl-job，elastic-job。比较之后决定深入学习一下xxl-job，主要是没有用过zk，xxl-job相对于我来说学习成本较低。

## xxl_job

这里贴上xxl-job的官网地址： https://www.xuxueli.com/xxl-job/

官网的说明和demo非常详细了，我还写介绍或者demo就完全是复制粘贴意义不大了。这里我主要是想根据任务分片具体到如何根据用户分片处理。

## 简单介绍一下分片任务

![](/img/java/ant_forest/image-20200821161738718.png)


# 再思考

现在我通过xxl-job分布式任务调度平台已经具备了部署多台执行器的能力，通过分片的方式可以允许我同时多台机器同步执行任务，那么现在我要做的就是拆分了。每台机器执行多少条数据，依据什么去做数据拆分。

每个任务执行器执行任务时，会接收到两个参数index（当前分片），total（总共有多少个任务执行器），这个就是能做任务拆分的条件。



## 根据用户属性做拆分

用户都有归属地，根据用户的归属地做拆分，具体思路，执行器接收到的index为1时，对所有上海地区的用户生成能量，index为2时，对所有北京地区的用户生成能量。

这样的实现比较简单，但是可能因为每个地区用户数量不同，每个执行器执行时间差距很大。



## 根据任务要执行的总记录数除以执行器做拆分

查询总的需要执行的记录数，假如是1000。执行器的总数是10

那么就可以index=1时，处理0-100，

index=2时，处理101-200以此类推。



## 业务上的优化处理

增加一张能量依据表，用户每一笔消费都产生一条记录，这里面存储用户消费的明细和要产生的能量，能量的产生全部依赖这张表。这张表增加一个mod字段，mod的值根据分片数取模生成。

这样index等于1的机器只要处理这张表mod值等于1的记录。

我目前想到的就是这三种实现方式，我更倾向于第三种的实现。












